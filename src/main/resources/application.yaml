server:
  port: 8081 # As defined in your Service Matrix

spring:
  application:
    name: muscledia-user-service

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:mysql://localhost:3306/muscledia}
    username: ${SPRING_DATASOURCE_USERNAME:springstudent}
    password: ${SPRING_DATASOURCE_PASSWORD:springstudent}
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: update # Or create, create-drop, validate depending on your needs
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true

    # Jackson Configuration to handle Long precision issues
  jackson:
    generator:
      write-numbers-as-strings: false # Keep this false to only target specific fields
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false
    default-property-inclusion: NON_NULL

  # Kafka - Optional for events (MVP: disabled, Production: enable with env var)
  kafka:
    bootstrap-servers: ${KAFKA_SERVERS:localhost:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      # Producer configuration for reliability and performance:
      acks: all # Guarantees message delivery
      retries: 3 # Number of retries for failed sends
      batch-size: 16384 # Default batch size (16KB)
      linger.ms: 5 # Time to wait before sending a batch
      # Idempotent producer for exactly-once delivery (important for robustness)
      properties:
        enable.idempotence: true
    consumer:
      group-id: ${KAFKA_GROUP:gamification-service}
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      properties:
        spring.json.trusted.packages: "com.muscledia.Gamification_service.event.*, com.muscledia.workout_service.event.*, com.muscledia.user_service.event.*" # IMPORTANT for JSON deserialization

kafka:
  events:
    enabled: true
  topics:
    user-events: user-events

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka # Point to Eureka Server

# Add debug logging to see what's happening
logging:
  level:
    com.muscledia.user_service: DEBUG
    org.springframework.kafka: INFO
    org.apache.kafka: WARN